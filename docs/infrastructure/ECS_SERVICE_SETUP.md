# ECSサービスとALBの作成手順（詳細版）

ECSサービスとALB（Application Load Balancer）を作成する手順です。

## 📋 必要な情報（メモしておいてください）

- **VPC ID**: `vpc-08f1650afa45efb02`
- **サブネット ID**: `subnet-0b2f1ff088671f7df`, `subnet-03ca53640de79ade0`
- **セキュリティグループ ID**: `sg-09e2841dce32a4347`
- **ECSクラスター**: `attendance-cluster`
- **タスク定義**: `attendance-backend-task`（GitHub Actionsで作成済み）

---

## 🚀 手順1: CloudWatch Logsグループの作成

### 目的
ECSタスクのログを保存するためのロググループを作成します。

### 手順

1. **AWSコンソール**で **「CloudWatch」** を検索して開く
2. 左側メニューから **「ログ」** → **「ロググループ」** をクリック
3. **「ロググループを作成」** ボタンをクリック
4. **「ロググループ名」** に `/ecs/attendance-backend` と入力
5. **「作成」** をクリック

> **💡 ヒント**: 既に存在する場合は、そのまま次に進んでください。

---

## 🚀 手順2: ALB（Application Load Balancer）の作成

### 目的
インターネットからのリクエストを受け取り、ECSタスクに転送するロードバランサーを作成します。

### 手順

#### ステップ1: ALB作成画面を開く

1. **AWSコンソール**で **「EC2」** を検索して開く
2. 左側メニューから **「ロードバランサー」** をクリック
3. **「ロードバランサーを作成」** ボタンをクリック
4. **「Application Load Balancer」** の **「作成」** ボタンをクリック

#### ステップ2: 基本設定

1. **「名前」** に `attendance-alb` と入力
2. **「スキーム」** で **「インターネット向け」** を選択（デフォルト）
3. **「IPアドレスタイプ」** で **「IPv4」** を選択（デフォルト）
4. **「次へ」** をクリック

#### ステップ3: ネットワークマッピング

1. **「VPC」** で `vpc-08f1650afa45efb02` を選択
2. **「アベイラビリティゾーン」** で以下にチェック：
   - `ap-northeast-1a`（利用可能なサブネットを選択）
   - `ap-northeast-1c`（利用可能なサブネットを選択）
   - （表示されているすべてのAZにチェックを入れてください）
3. **「次へ」** をクリック

#### ステップ4: セキュリティグループ

1. **「既存のセキュリティグループを選択」** を選択
2. `sg-09e2841dce32a4347`（attendance-ecs-sg）にチェックを入れる
3. **デフォルトのセキュリティグループ**（`default`）のチェックは**外す**
4. **「次へ」** をクリック

#### ステップ5: リスナーとルーティング

1. **「リスナー」** セクション：
   - **「プロトコル」**: HTTP（デフォルト）
   - **「ポート」**: 80（デフォルト）
2. **「デフォルトアクション」** で **「新しいターゲットグループを作成」** を選択
3. **「次へ」** をクリック

#### ステップ6: ターゲットグループの設定

1. **「ターゲットタイプ」** で **「IPアドレス」** を選択
2. **「名前」** に `attendance-tg` と入力
3. **「プロトコル」**: HTTP（デフォルト）
4. **「ポート」**: 80（デフォルト）
5. **「VPC」** で `vpc-08f1650afa45efb02` を選択
6. **「ヘルスチェック」** セクション：
   - **「プロトコル」**: HTTP
   - **「パス」**: `/api/health` と入力
   - **「正常性チェック間隔」**: 30秒
   - **「タイムアウト」**: 5秒
   - **「正常な閾値」**: 2
   - **「異常な閾値」**: 3
7. **「次へ」** をクリック

#### ステップ7: 確認と作成

1. 設定内容を確認
2. **「ロードバランサーを作成」** をクリック
3. **「サービスリンクロールを作成しますか？」** というメッセージが表示された場合：
   - **「作成」** をクリック（初回のみ、これは正常な動作です）
4. ALBの作成が完了するまで**数分待ちます**
   - ステータスが **「アクティブ」** になるまで待機

#### ステップ8: ALBのDNS名を確認

1. **「ロードバランサー」** 一覧で `attendance-alb` をクリック
2. **「説明」** タブで **「DNS名」** を確認（例: `attendance-alb-123456789.ap-northeast-1.elb.amazonaws.com`）
3. **このDNS名をメモしてください**（後でGitHub Secretsに設定します）

---

## 🚀 手順3: ECSサービスの作成

### 目的
ECSタスクを実行し、ALBと連携するサービスを作成します。

### 手順

#### ステップ1: ECSクラスターを開く

1. **AWSコンソール**で **「ECS」** を検索して開く
2. 左側メニューから **「クラスター」** をクリック
3. **「attendance-cluster」** をクリック

#### ステップ2: サービス作成画面を開く

1. **「サービス」** タブをクリック
2. **「作成」** ボタンをクリック

#### ステップ3: サービス設定

1. **「起動タイプ」** で **「Fargate」** を選択
2. **「オペレーティングシステム/アーキテクチャ」** で **「Linux/X86_64」** を選択（デフォルト）
3. **「タスク定義」** セクション：
   - **「ファミリー」** で `attendance-backend-task` を選択
   - **「リビジョン」** で **「最新（LATEST）」** を選択
4. **「サービス名」** に `attendance-api-service` と入力
5. **「サービスタイプ」** で **「Replica」** を選択（デフォルト）
6. **「必要なタスク数」** に `1` と入力
7. **「次へ」** をクリック

#### ステップ4: ネットワーク設定

1. **「VPC」** で `vpc-08f1650afa45efb02` を選択
2. **「サブネット」** で以下を選択：
   - `subnet-0b2f1ff088671f7df`
   - `subnet-03ca53640de79ade0`
   - （表示されているサブネットから選択）
3. **「セキュリティグループ」** で `sg-09e2841dce32a4347`（attendance-ecs-sg）を選択
4. **「パブリックIPの自動割り当て」** で **「有効」** を選択
5. **「次へ」** をクリック

#### ステップ5: ロードバランシング設定

1. **「ロードバランサータイプ」** で **「Application Load Balancer」** を選択
2. **「ロードバランサー」** で `attendance-alb` を選択
3. **「コンテナ名」** で `laravel-api` を選択
4. **「コンテナポート」** に `80` と入力
5. **「ターゲットグループ」** で `attendance-tg` を選択
6. **「次へ」** をクリック

#### ステップ6: サービス検出（スキップ）

1. **「サービス検出（オプション）」** はスキップ
2. **「次へ」** をクリック

#### ステップ7: オートスケーリング（スキップ）

1. **「オートスケーリング（オプション）」** はスキップ
2. **「次へ」** をクリック

#### ステップ8: 確認と作成

1. 設定内容を確認
2. **「サービスの作成」** をクリック
3. サービスの作成が完了するまで**数分待ちます**

---

## ✅ 作成後の確認

### 1. ALBのDNS名を確認

1. **EC2コンソール** → **ロードバランサー** → `attendance-alb` を選択
2. **「説明」** タブで **「DNS名」** を確認
3. 例: `attendance-alb-123456789.ap-northeast-1.elb.amazonaws.com`

### 2. ECSサービスの状態を確認

1. **ECSコンソール** → **クラスター** → `attendance-cluster` → **サービス** タブ
2. `attendance-api-service` の状態が **「実行中」** になっているか確認
3. **「タスク」** タブでタスクが **「実行中」** になっているか確認

### 3. GitHub Secretsの更新

1. **GitHubリポジトリ** → **Settings** → **Secrets and variables** → **Actions**
2. 以下のSecretsを更新：
   - **`API_URL`**: `http://[ALBのDNS名]`
     - 例: `http://attendance-alb-123456789.ap-northeast-1.elb.amazonaws.com`
   - **`REACT_APP_API_URL`**: `http://[ALBのDNS名]`
     - 例: `http://attendance-alb-123456789.ap-northeast-1.elb.amazonaws.com`

### 4. 再度デプロイを実行

```bash
git push origin main
```

---

## 🆘 トラブルシューティング

### ALBが「プロビジョニング中」のまま

- 数分待ってください（通常5-10分かかります）
- ステータスが「アクティブ」になるまで待機

### ECSサービスが起動しない

- **タスク** タブでエラーメッセージを確認
- タスク定義が正しく登録されているか確認
- セキュリティグループの設定を確認

### ヘルスチェックが失敗する

- `/api/health` エンドポイントが実装されているか確認
- セキュリティグループでポート80が開いているか確認

---

## 📝 メモ用テンプレート

```
ALB DNS名: _________________________________
ターゲットグループARN: _________________________________
ECSサービス名: attendance-api-service
```

---

**参考**: [GET_STARTED.md](./GET_STARTED.md)
